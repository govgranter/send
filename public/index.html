<!DOCTYPE html>
<html>
<head>
    <title>Message Receiver</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #messageDisplay { border: 2px solid #28a745; padding: 20px; margin: 20px 0; min-height: 100px; 
                         border-radius: 10px; background: #f8f9fa; }
        .status { color: #666; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .message { font-size: 18px; margin: 15px 0; padding: 10px; background: white; 
                  border-radius: 5px; border-left: 4px solid #007bff; }
        .timestamp { color: #888; font-size: 12px; margin-top: 5px; }
        .loading { color: #17a2b8; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h2>ðŸ“¥ Live Message Receiver (POST Method)</h2>
    <div class="status info">
        âœ… Connected - Listening for new messages...
        <br><small>Using long-polling for instant updates</small>
    </div>
    <div id="messageDisplay">
        <div class="status">No messages yet. Send a message from the sender page!</div>
    </div>
    <button onclick="clearDisplay()" style="padding: 8px 15px; margin-top: 10px;">Clear Display</button>

    <script>
        const messageDisplay = document.getElementById('messageDisplay');
        let lastMessageId = '0';

        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/api/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    displayMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
                showError('Failed to fetch messages. Retrying...');
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

        // Alternative: Simple polling (every 1 second)
        async function pollMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/api/messages/poll?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    displayMessages(newMessages);
                    lastMessageId = newMessages[newMessages.length - 1].id;
                }
            } catch (error) {
                console.error('Error polling messages:', error);
                showError('Connection error. Retrying...');
            }
        }

        function displayMessages(messages) {
            messages.forEach(message => {
                const time = new Date(message.timestamp).toLocaleTimeString();
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    ðŸ’¬ ${message.text}
                    <div class="timestamp">Received at: ${time}</div>
                `;
                messageDisplay.appendChild(messageElement);
            });

            // Remove "no messages" placeholder if it exists
            const placeholder = messageDisplay.querySelector('.status');
            if (placeholder && messages.length > 0) {
                placeholder.remove();
            }

            // Scroll to bottom
            messageDisplay.scrollTop = messageDisplay.scrollHeight;
        }

        function showError(message) {
            const errorElement = document.createElement('div');
            errorElement.className = 'status error';
            errorElement.textContent = message;
            messageDisplay.appendChild(errorElement);
            
            setTimeout(() => {
                if (errorElement.parentNode) {
                    errorElement.remove();
                }
            }, 3000);
        }

        function clearDisplay() {
            messageDisplay.innerHTML = '<div class="status">Display cleared. Waiting for new messages...</div>';
            lastMessageId = '0';
        }

        // Start polling when page loads
        window.addEventListener('load', () => {
            // Choose one method:
            fetchMessages(); // Long-polling (more efficient)
            // setInterval(pollMessages, 1000); // Simple polling (every second)
        });
    </script>
</body>
</html>

