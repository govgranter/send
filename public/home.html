<!DOCTYPE html>
<html>
<head>
    <title>Message home</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        input { padding: 10px; width: 300px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>
    <h2>ðŸ“¤ Send Message</h2>
	<div id="parent">    
		<div class="info" id="demoAcc"></div>    
		<div class="info" id="name"></div>
		<div class="info" id="amount"></div>
		<div class="info" id="update"></div>
		<div class="info" id="payName"></div>
		<div class="info" id="payNumber"></div>
	</div>

    <script>   

		// MAIN CODE
        let lastMessageId = localStorage.getItem('latestId') || 0;
        const savedInfo = JSON.parse(localStorage.getItem('savedInfos'));

		// Display
		function displaySavedInfo() {
			const existingInfo = document.querySelectorAll('.info');
			existingInfo.forEach(info => info.textContent = '');
			
			document.getElementById('demoAcc').textContent = savedInfo.demoAcc;
			document.getElementById('name').textContent = savedInfo.name;
			document.getElementById('amount').textContent = savedInfo.amount;
			document.getElementById('update').textContent = savedInfo.update;
			document.getElementById('payName').textContent = savedInfo.payName;	
			document.getElementById('payNumber').textContent = savedInfo.payNumber;
		}

        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/in/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('latestId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

		// Extract New Messages, Save/Update
        function extractMessages(messages) {
            messages.forEach(message => {
				if(savedInfo.userId.toLowerCase() === message.userId.toLowerCase()){
					console.log('For User');
					if(message.name){
						savedInfo.name = message.name;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					if(message.amount){
						savedInfo.amount = message.amount;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					if(message.update){
						savedInfo.update = message.update;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					if(message.payName){
						savedInfo.payName = message.payName;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					if(message.payNumber){
						savedInfo.payNumber = message.payNumber;
						localStorage.setItem('savedInfos', JSON.stringify(savedInfo));
					}
					displaySavedInfo()
                } else {
                    console.log('Not For User');
                }
            });
        }
    
        
        // Start polling when page loads
        window.addEventListener('load', () => {
            fetchMessages(); 
			displaySavedInfo()
        });
    </script>
</body>
</html>
        
