<!DOCTYPE html>
<html>
<head>
    <title>Message Receiver</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #messageDisplay { border: 2px solid #28a745; padding: 20px; margin: 20px 0; min-height: 100px; 
                         border-radius: 10px; background: #f8f9fa; }
        .status { color: #666; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .message { font-size: 18px; margin: 15px 0; padding: 10px; background: white; 
                  border-radius: 5px; border-left: 4px solid #007bff; }
        .timestamp { color: #888; font-size: 12px; margin-top: 5px; }
        .loading { color: #17a2b8; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h2>ðŸ“¥ Live Message Receiver (POST Method)</h2>
    <div class="status info">
        âœ… Connected - Listening for new messages...
        <br><small>Using long-polling for instant updates</small>
    </div>
    <div id="messageDisplay">
        <div class="user">
            <p class="id"></p>
            <p class="message"></p>
            <p class="account"></p>
            <form class="form" method="post">
                <input type="text" name="input">
                <input type="submit" value="Submit">
            </form>
        </div>
    </div>

    <script>
        const messageDisplay = document.getElementById('messageDisplay');
        const userTemplate = messageDisplay.querySelector('.user');
        let lastMessageId = localStorage.getItem('lastId') || 0;
        let savedUsers = JSON.parse(localStorage.getItem('savedUsers')) || [];

          savedUsers.forEach((user, index) => {
              const usersClone = userTemplate.cloneNode(true);
              usersClone.querySelector('.id').textContent = user.id;
              usersClone.querySelector('.message').textContent = user.message;
              usersClone.querySelector('.account').textContent = user.account;
              const form = usersClone.querySelector('.form');
              
              form.addEventListener('submit', (event) => {
                  event.preventDefault();
                  const formData = new FormData(form);
                  const message = formData.get('input');
                  updateUserById(user.id, 'account', message);
              })
              $('.messageDisplay').first().hide();
              messageDisplay.appendChild(usersClone);
          });
        

        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/api/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('lastId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }
       
        function extractMessages(messages) {
            messages.forEach(message => {
                const newUserId = message.user;
                const newMessage = message.message;
                const existing = savedUsers.find(user => user.id.toLowerCase() === newUserId.toLowerCase());
                if (existing) {
                    alert('user already saved');
                    updateUserById(newUserId, 'message', newMessage);
                } else {
                    alert('new user');
                    savedUsers.push({
                        id: newUserId,
                        message: newMessage,
                        account: null
                    });
                    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
                }
            });
        }
        
function updateUserById(id, property, value) {
  const itemIndex = savedUsers.findIndex(user => user.id === id);
  if (itemIndex !== -1) {
    savedUsers[itemIndex][property] = value;
    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
  }
}
        
        // Start polling when page loads
        window.addEventListener('load', () => {
            // Choose one method:
            fetchMessages(); // Long-polling (more efficient)
        });
    </script>
</body>
</html>
