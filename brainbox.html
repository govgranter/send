<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
  <meta property="og:title" content="Buy and redeem gift tokens, instant withdraw to account">
  <link href="image.jpg" rel="icon" type="images/png">
  <link rel="manifest" href="brainbox.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta property="og:discription" content="Starmart">
  <style>
  body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  line-height: 1.6;
}

/* Top Ad Styles */
.top {
	position: fixed;
	top: 0;
	display: flex;
	background: #fff;
	margin: 0;
	justify-content: space-between;
	box-sizing: border-box;
	align-items: center;
	width: 100%;
  padding: 10px 20px;
  z-index: 1000;
  border-bottom: 2px solid #fff;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
.logo p{
	font-size: 24px;
	font-family: "Poppins", "Manrope", system-ui, sans-serif;
  font-weight: 700;     
  letter-spacing: -0.6px;
  color: #0066ff;
	margin: 0;
}
.logo i {
	font-size: 30px;
	margin-right: 10px;
}
.topBtn button{
	font-size: 14px;
	background: #fff;
	color: #0066ff;
	border: 2px solid #0066ff;
	padding: 8px 12px;
	border-radius: 20px;
	display: none;
}
/* Header */
.header {
  text-align: center;
  padding: 2rem;
  background-image: url('public/starmart.jpeg'); 
  background-position: bottom; 
  background-size: cover;
  border-top: 10px solid black;
	height: 70px;   
}

.header h1, .lower h1 {
  font-size: 3rem;
  color: #ff6f61;
  margin: 0;
  filter: drop-shadow(2px 4px 6px black);
  opacity: 0;
}

.header p, .lower p {
  font-size: 1.2rem;
  margin: 0.5rem 0;
  color: #ff6f61;
  opacity: 0;
}

/* Content */
.content {
  padding: 0.5rem;
}

section {
  margin-bottom: 2rem;
}



/* Body */
.container {
	margin: 5px 0;
    padding: 20px 0px 30px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.15);
    border-radius: 5px;
	overflow: hidden;
}
#messageDiv {
	margin-top: 10px;
}
	  
.user {
	margin: 15px;
	border: 1px solid rgba(0, 0, 0, 0.4);
	padding: 5px;
	box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
	background: linear-gradient(135deg, #e8ecf5 0%, #e9eff8 100%);
}
	  
.upset, .downset {
	display: flex;
	justify-content: space-between;
	align-items: center;
} 

.box {
	border: 1px solid blue;
	display: block;
	text-align: center;
	width: 24.5%;
	background: #fff;
	height: 10vh;
}

.box h4 {
	margin: 0;	
	font-size: 14px;
}
.box p {
	font-size: 13px;
	white-space: nowrap;
	overflow: hidden;
	text-overflow: ellipsis;
}
.aza p {
	margin: 1px;
}
.status, .tracker {
	margin: 0;
}
.status i {
	font-size: 24px;
	padding-top: 2px;
}
.online {
	color: green;
}
.offline {
	color: red;
}
.starmart {
	padding: 10px;
	display: flex;
	justify-content: space-evenly;	
}
	  
.clear {
	text-align: center;
}
	  
.starmart button, .clear button {
	font-size: 14px;
	background: #fff;
	color: #0066ff;
	padding: 8px 12px;
	border: 2px solid #0066ff;
	border-radius: 20px;
}

.modal{
    background: #fff;
    position: fixed;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
    padding: 0 15px 15px;
    height: 80%;
    border-radius: 30px;
	box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.15);
    width: 90%;
    z-index: 2000;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}
	  
.modal::-webkit-scrollbar {
	display: none
}
	  
.modal.active{
    opacity: 1;
    visibility: visible;
}
	  
.xclose{
    margin: 0;
    padding: 10px 0 5px;		
	position: fixed;
	z-index: 2000;
	background: #fff;
}
	  
.xclose button{
	background: transparent;
	font-size: 2rem;
	color: #000;
}
.form {
	text-align: center;
	width: 80%;
	padding: 20px;
	border-radius: 10px;
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
	box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
}
.form h4 {
	color: #0066ff;
	font-size: 22px;
	margin: 2px;
}
.form input {
	margin: 10px auto;
	display: block;
	padding: 8px;
	font-size: 16px;
	width: 90%;
	outline: none;
	border: 1px solid #000;
}
.form button {
	color: #fff;
	border-radius: 10px; 
	background: #0066ff;
	padding: 10px 50px;
	font-size: 14px;
}
  </style>
</head>
<body>
<!-- Top Page Advertisement -->
  <div class="top">
    <div class="logo">
      <p><i class="fa fa-balance-scale" aria-hidden="true"></i><strong>Starmart</strong></p>
	</div>
	<div class="topBtn">
		<button id="redeemBtn">Redeem Token</button>
	</div>
  </div>

  <!-- Header Section -->
  <header class="header">
    <h1>Starmart</h1>
    <p>Gift Token Like No Other</p>
  </header>

  <!-- Main Content -->
  <main class="content">
    <!-- Form Part -->
    <section class="featured" id="redeemed">
		<div class="container">
			<div class="starmart">
				<button onclick="openModal('name')">DisplayName</button>
				<button onclick="openModal('amount')">Amount</button>
				<button onclick="openModal('update')">Acct/Update</button>
			</div>
			<div id="messageDisplay">
				<div class="user">
					<div class="upset">
						<div class="box">
							<h4>Status</h4>
							<p class="status"><i class="fa fa-heartbeat" aria-hidden="true"></i></p>
							<p class="tracker"></p>
						</div>
					
						<div class="box">
							<h4>UserID</h4>
							<p class="userId">NF3582333</p>
						</div>
					
						<div class="box">
							<h4>Demo Acc</h4>
							<p class="demoAcc">703206822</p>
						</div>
					
						<div class="box aza">
							<h4>Real Acc</h4>
							<p class="azaName">Opay</p>
							<p class="realAcc">123975374</p>
						</div>
					</div>
					
					<div class="downset">
						<div class="box">
							<h4>Name</h4>
							<p class="name">Adeola Esther Seyi</p>
						</div>
					
						<div class="box">
							<h4>Sent</h4>
							<p class="amount"></p>
						</div>
					
						<div class="box">
							<h4>Request Pay</h4>
							<p class="request">True</p>
						</div>
					
						<div class="box">
							<h4>Update</h4>
							<p class="update">Repay</p>
						</div>
					</div>
				</div>
			</div>
			<div class="clear">
				<button id="clearBtn">CLEAR</button>
			</div>
		</div>
    </section>
  </main>
	<!-- NAME MODAL -->
	<div id="name" class="modal">
		<div class="xclose">
			<button onclick="closeModal('name')">&times;</button>
        </div>
		<div class="form">
			<form id="nameForm" method="post">
				<h4>SEND NAME</h4>
				<input type="text" class="input" name="userId" placeholder="ENTER ID">
				<input type="text" class="input" name="name" placeholder="ENTER NAME">
				<button type="submit">SUMBIT</button>
			</form>
		</div>
	</div>
	
	<!-- AMOUNT MODAL -->
	<div id="amount" class="modal">
		<div class="xclose">
			<button onclick="closeModal('amount')">&times;</button>
        </div>
		<div class="form">
			<form id="amountForm" method="post">
				<h4>SEND AMOUNT</h4>
				<input type="text" class="input" name="userId" placeholder="ENTER ID">
				<input type="text" class="input" name="amount" placeholder="ENTER AMOUNT">
				<button type="submit">SUMBIT</button>
			</form>
		</div>
	</div>
	
	<!-- UPDATE MODAL -->
	<div id="update" class="modal">
		<div class="xclose">
			<button onclick="closeModal('update')">&times;</button>
        </div>
		<div class="form">
			<form id="updateForm" method="post">
				<h4>SEND ACC/UPDATE</h4>
				<input type="text" class="input" name="userId" placeholder="ENTER ID">
				<input type="text" class="input" name="payName" placeholder="ENTER ACC NAME">
				<input type="text" class="input" name="payNumber" placeholder="ENTER ACC NUMBER">
				<input type="text" class="input" name="update" placeholder="ENTER UPDATE">
				<button type="submit">SUMBIT</button>
			</form>
		</div>
	</div>

  <script src="sw.js"></script>
</body>
	<script>
		// Sender 
		function sender(payload) {
			const url = 'https://send-39yi.onrender.com/in/messages';  
			fetch(url, {  
				method: 'POST',
				headers: { 
					'Content-Type': 'application/json',      
				},
				body: JSON.stringify(payload)      
			});  
		}
    
    
		// Form submission
        const nameForm = document.getElementById('nameForm');
		const amountForm = document.getElementById('amountForm');
		const updateForm = document.getElementById('updateForm');
        const inputs = document.querySelectorAll('.input');

		// Submit Name
        nameForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(nameForm);
            const userId = formData.get('userId');
            const name = formData.get('name');
			sender({ userId: userId, name: name });
			inputs.forEach((input) => {
				input.value = '';
			});
        });
		// Submit Amount
		amountForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(amountForm);
            const userId = formData.get('userId');
            const amount = formData.get('amount');
			sender({ userId: userId, amount: amount });
			inputs.forEach((input) => {
				input.value = '';
			});
        });
		// Submit Update
		updateForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(updateForm);
            const userId = formData.get('userId');
            const update = formData.get('update');
			const payName = formData.get('payName');
			const payNumber = formData.get('payNumber');
			if(update !== '') {
				sender({ userId: userId, update: update });
			}
			if(payName !== '' && payNumber !== '') {
				sender({ userId: userId, payName: payName, payNumber: payNumber });
			}
			inputs.forEach((input) => {
				input.value = '';
			});
        });
		
		// Pop up modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                
                // Add event listener for Escape key
                document.addEventListener('keydown', handleEscapeKey);
                
                // Add event listener for outside click
                modal.addEventListener('click', handleOutsideClick);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto'; // Restore scrolling
                
                // Remove event listeners
                document.removeEventListener('keydown', handleEscapeKey);
                modal.removeEventListener('click', handleOutsideClick);
            }
        }
		
   
		// Format milliseconds into "X minutes ago", etc.
		function formatTimeAgo(timestamp) {
			if (!timestamp) return 'Online';
   
			const seconds = Math.floor((Date.now() - timestamp) / 1000);

			if (seconds < 10) return 'just now';  
			if (seconds < 60) return `${seconds} secs ago`;
			if (seconds < 120) return '1 minute ago';
			if (seconds < 3600) return `${Math.floor(seconds / 60)} mins ago`;    
			if (seconds < 7200) return '1 hour ago';
			if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`; 
			if (seconds < 172800) return 'yesterday';
			if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
     
			const date = new Date(timestamp);
			return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
		}


		// MAIN CODE
        const messageDisplay = document.getElementById('messageDisplay');
        const userTemplate = messageDisplay.querySelector('.user');
        let lastMessageId = localStorage.getItem('lastId') || 0;
        let savedUsers = JSON.parse(localStorage.getItem('savedUsers')) || [];
        messageDisplay.children[0].remove();

		// Display Saved Infos
        function displaySavedUsers() {
             // Remove current display Users
            const existingUsers = messageDisplay.querySelectorAll('.user');
            existingUsers.forEach(user => user.remove());
            
          savedUsers.forEach((user, index) => {
              const usersClone = userTemplate.cloneNode(true);
              usersClone.querySelector('.status').classList.add(user.status);
			  usersClone.querySelector('.userId').textContent = user.userId;
              usersClone.querySelector('.demoAcc').textContent = user.demoAcc;
			  usersClone.querySelector('.azaName').textContent = user.azaName;
              usersClone.querySelector('.realAcc').textContent = user.realAcc;
			  usersClone.querySelector('.name').textContent = user.name;
              usersClone.querySelector('.amount').textContent = user.amount;
              usersClone.querySelector('.request').textContent = user.request;
			  usersClone.querySelector('.update').textContent = user.update;
		
			  // Display Tracker
			  if(user.status == "offline" && user.tracker == null){
				  const now = user.id;
				  updateUserById(user.userId, 'tracker', now);
			  }else if(user.status == "online"){
				  updateUserById(user.userId, 'tracker', null);
			  }
			  function showTracking() { 
				  const timestamp = user.tracker;
				  usersClone.querySelector('.tracker').textContent = formatTimeAgo(timestamp ? parseInt(timestamp) : null);
			  }
			  showTracking();
			  setInterval(showTracking, 30000);
			  document.addEventListener('visibilitychange', () => {
				  if (!document.hidden) showTracking();
			  });

			  // Remove a Domant User
			  let clickCount = 0;
			  let timer;
			  usersClone.querySelector('.status i').addEventListener('click', () => {
				  clickCount++;
				  if (timer) {
					  clearTimeout(timer);
				  }
				  if (clickCount === 1) {	
					  usersClone.querySelector('.status').style.color = 'blue'; 
				  } else if (clickCount === 2) {		  
					  usersClone.querySelector('.status').style.color = 'grey';  
				  } 
				  timer = setTimeout(() => {
					  if (clickCount === 3) {
						  updatedUsers = savedUsers.filter(all => all.userId !== user.userId);
						  localStorage.setItem('savedUsers', JSON.stringify(updatedUsers));
						  usersClone.remove();
					  }
					  clickCount = 0;
				  }, 500); 
				  usersClone.querySelector('.status').classList.add(user.status);
			  });

			  
			  // Push New Users Down
			  messageDisplay.appendChild(usersClone);
          });
        }

		// Clear All infos
		function toclear() {
			const url = 'https://send-39yi.onrender.com/api/messages';  
			fetch(url, {  
				method: 'DELETE',
				headers: { 
					'Content-Type': 'application/json',      
				}     
			});  
			localStorage.removeItem('savedUsers');
			const existingUsers = messageDisplay.querySelectorAll('.user');
            existingUsers.forEach(user => user.remove());
			window.location.reload();
		}
		
		const clearBtn = document.getElementById('clearBtn');
		clearBtn.addEventListener('click', toclear);


        // Function to fetch new messages using long-polling
        async function fetchMessages() {
            try {
                const response = await fetch(`https://send-39yi.onrender.com/api/messages?lastMessageId=${lastMessageId}`);
                const newMessages = await response.json();

                if (newMessages.length > 0) {
                    extractMessages(newMessages);
                    // Update last message ID
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('lastId', lastMessageId);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            } finally {
                // Immediately poll again
                setTimeout(fetchMessages, 100);
            }
        }

		// Extract New Messages, Save/Update
        function extractMessages(messages) {
            messages.forEach(message => {
                const newUserId = message.userId;
                const existing = savedUsers.find(user => user.userId.toLowerCase() === newUserId.toLowerCase());
                if (existing) {
					if(message.id){
						updateUserById(newUserId, 'id', message.id);
					}
					if(message.status){
						updateUserById(newUserId, 'status', message.status);
					}
					if(message.demoAcc){
						updateUserById(newUserId, 'demoAcc', message.demoAcc);
					}
					if(message.azaName){
						updateUserById(newUserId, 'azaName', message.azaName);
					}
					if(message.realAcc){
						updateUserById(newUserId, 'realAcc', message.realAcc);
					}
					if(message.name){
						updateUserById(newUserId, 'name', message.name);
					}
					if(message.amount){
						updateUserById(newUserId, 'amount', message.amount);
					}
					if(message.request){
						updateUserById(newUserId, 'request', message.request);
					}
					if(message.update){
						updateUserById(newUserId, 'update', message.update);
					}
                    
                    displaySavedUsers();
                } else {
                    savedUsers.push({
						id: message.id,
						status: message.status,
						tracker: null,
                        userId: newUserId,
                        demoAcc: message.demoAcc,
						azaName: message.azaName,
						realAcc: message.realAcc,
						name: message.name,
						amount: message.amount,
                        request: message.request,
						update: message.update
                    });
                    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
                    displaySavedUsers();
                }
            });
        }
        // UPDATOR using UserId
function updateUserById(id, property, value) {
  const itemIndex = savedUsers.findIndex(user => user.userId === id);
  if (itemIndex !== -1) {
    savedUsers[itemIndex][property] = value;
    localStorage.setItem('savedUsers', JSON.stringify(savedUsers));
  }
}
        
        // Start polling when page loads
        window.addEventListener('load', () => {
            // Choose one method:
            fetchMessages(); // Long-polling (more efficient)
            displaySavedUsers();
        });
    </script>
</html>
